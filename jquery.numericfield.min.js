(function(a){a.widget("numericfield",{options:{maxValue:null,minValue:null,decimalPlaces:0,stepUp:1,stepDown:1,allowSteps:true,specialAllowedKeys:[35,36,37,38,39,40,46,8,9,27,13],ctrlAllowedKeys:[65,67,86],realTimeChange:false,quietMillis:300},_create:function(){var c=this;var d=this.element;var e=this.options;var b=false;this.name="numericfield";this.previousValue=null;this.options.regex=this._buildRegex();d.on("focus."+this.name,function(f){c.previousValue=c._getValue()});d.on("blur."+this.name,function(f){d.val(c._properFormat(d.val()));c._ensureValidValue(false,true);if(c._getValue()!==c.previousValue){c._raiseOnChange(false,true)}});d.on("keydown."+this.name,function(f){if(a.inArray(f.which,e.specialAllowedKeys)!=-1){b=true;if(f.which===38){c.stepUp(true)}else{if(f.which===40){c.stepDown(true)}}}else{if(f.ctrlKey===true&&a.inArray(f.which,e.ctrlAllowedKeys)!=-1){b=true}else{b=false}}});d.on("keypress."+this.name,function(i){if(b===true){b=false;return}var h=c._getSelection();var j=(d.val()||"").toString();var g=String.fromCharCode(i.which);var k=j.substring(0,h.start)+g+j.substr(h.end);var f=e.regex.exec(k);if(f===null||f.length<=0||f[0]!==k){i.preventDefault()}c._ensureValidValue(true)});d.on("keyup."+this.name,function(f){c._ensureValidValue(true)})},_init:function(){this._ensureValidValue(false)},_setOption:function(b,c){a.Widget.prototype._setOption.apply(this,arguments);if(b==="minValue"||b==="decimalPlaces"){this._setOption("regex",this._buildRegex())}if(b==="maxValue"||b==="minValue"||b==="decimalPlaces"){this._ensureValidValue(false)}},_ensureValidValue:function(f,e){var d=this.element;var g=this.options;var b=this._properFormat(d.val());var c=parseFloat(b);if((b===""||b==="-")&&f){return}if(isNaN(c)){d.val(0);c=0;if(!e){this._raiseOnChange()}}if(g.minValue!==null&&c<g.minValue&&!f){d.val(g.minValue);c=g.minValue;if(!e){this._raiseOnChange()}}if(g.maxValue!==null&&c>g.maxValue&&!f){d.val(g.maxValue);c=g.maxValue;if(!e){this._raiseOnChange()}}if(c!==this._roundNumber(c)){c=this._roundNumber(c);d.val(c);if(!e){this._raiseOnChange()}}},_properFormat:function(b){b=(b||"").toString();if(b.length>0&&b.charAt(0)==="."){b="0"+b}if(b.length>0&&b.charAt(b.length-1)==="."){b=b.substr(0,b.length-1)}if(parseFloat(b)===0&&b.charAt(0)==="-"){b="0"}return b},_roundNumber:function(b){if(this.options.decimalPlaces<=0){return Math.round(b)}var c=Math.pow(10,this.options.decimalPlaces);return Math.round(b*c)/c},_getSelection:function(){var f=this.element[0];var i=0,d=0,h,e,c,b,g;if(typeof f.selectionStart==="number"&&typeof f.selectionEnd==="number"){i=f.selectionStart;d=f.selectionEnd}else{if(document.selection){e=document.selection.createRange();if(e&&e.parentElement()===f){b=f.value.length;h=f.value.replace(/\r\n/g,"\n");c=f.createTextRange();c.moveToBookmark(e.getBookmark());g=f.createTextRange();g.collapse(false);if(c.compareEndPoints("StartToEnd",g)>-1){i=d=b}else{i=-c.moveStart("character",-b);i+=h.slice(0,i).split("\n").length-1;if(c.compareEndPoints("EndToEnd",g)>-1){d=b}else{d=-c.moveEnd("character",-b);d+=h.slice(0,d).split("\n").length-1}}}}}return{start:i,end:d}},_buildRegex:function(){var c=this.options;var b=(c.minValue<0?"^-?\\d*":"^\\d+")+(c.decimalPlaces>0?"(.\\d{0,"+c.decimalPlaces+"})?":"");return new RegExp(b)},_getValue:function(){var d=this.element;var b=this._properFormat(d.val());var c=parseFloat(b);return c},_setValue:function(e,c,b){var d=this.element;d.val(e);this._ensureValidValue(false,true);this._raiseOnChange(c,b)},_raiseOnChange:(function(){var b;return function(f,e){var d=this;var c=d.options.realTimeChange||e;window.clearTimeout(b);if(c){var h=d.options.quietMillis;f=f&&h>0;if(f){b=window.setTimeout(function(){var i=d.element;i.change();d.previousValue=d._getValue()},h)}else{var g=d.element;g.change();d.previousValue=d._getValue()}}}})(),destroy:function(){var b=this.element;b.off("."+this.name);a.Widget.prototype.destroy.call(this)},value:function(b){if(arguments.length==0){return this._getValue()}else{this._setValue(b||0,false,true);return this._getValue()}},stepUp:function(b,c){if(!this.options.allowSteps){return}var d=(arguments.length>1?c:this.options.stepUp);if(typeof(d)!=="number"){return}this._setValue(this._getValue()+d,b)},stepDown:function(b,d){if(!this.options.allowSteps){return}var c=(arguments.length>1?d:this.options.stepDown);if(typeof(c)!=="number"){return}this._setValue(this._getValue()-c,b)}})})(jQuery);